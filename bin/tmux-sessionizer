#!/usr/bin/env bash
# credits: ThePrimagen
# source: https://github.com/ThePrimeagen/.dotfiles/blob/master/bin/.local/scripts/tmux-sessionizer

work_dirs="$HOME/Projects"

if [[ $# -eq 1 ]]; then
  selected=$1
else
  selected=$(find $work_dirs -mindepth 1 -maxdepth 1 -type d | fzf)
fi

if [[ -z $selected ]]; then
  exit 0
fi

selected_name=$(basename "$selected" | tr . _)
tmux_running=$(pgrep tmux)

venv_fish_activate="$selected/venv/bin/activate.fish"

if [[ -f "$venv_fish_activate" ]]; then
  # Create a temporary fish config that sources the activate.fish and then starts interactive shell
  shell_cmd="fish --init-command 'source \"$venv_fish_activate\"'"
else
  shell_cmd="fish"
fi

if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
  tmux new-session -s "$selected_name" -c "$selected" "$shell_cmd"
  exit 0
fi

if ! tmux has-session -t=$selected_name 2>/dev/null; then
  tmux new-session -ds "$selected_name" -c "$selected" "$shell_cmd"
fi

if [[ -z $TMUX ]]; then
  tmux attach -t "$selected_name"
else
  tmux switch-client -t "$selected_name"
fi
